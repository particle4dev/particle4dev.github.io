{"componentChunkName":"component---src-templates-blog-post-template-js","path":"/2019-05-16-how-to-setup-kops-on-aws/","result":{"data":{"site":{"siteMetadata":{"title":"Front End / Fullstack Developer / DevOps / Scrum Master","author":"@particle4dev"}},"markdownRemark":{"id":"850184c3-7540-5e51-9f84-7bf318ba66f1","excerpt":"CẬP NHÂT:  Có rất nhiều cách để run K8S trên AWS như EKS hay sử dụng Kops. Kops là 1 cách đơn giản và dễ dàng customize  việc cài đặt K8S. Trong bài viết này…","htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{"align":"center"},"children":[{"type":"text","value":"\n\t"},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/25578d904e75c8bffd298a079b4a3e89/c23ee/kops-logo.jpg","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 44.591510725696025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAABAAD/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABanTUNJj/xAAbEAACAQUAAAAAAAAAAAAAAAAAEgMBAhATQ//aAAgBAQABBQJr9jSUHkOuP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABkQAAMAAwAAAAAAAAAAAAAAAAAyQRCBkf/aAAgBAQAGPwK8gghrP//EAB0QAAIBBAMAAAAAAAAAAAAAAAERABAxUXGB8PH/2gAIAQEAAT8hDLOI3XhELZOH0zvzX//aAAwDAQACAAMAAAAQk8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAdEAEBAAIBBQAAAAAAAAAAAAABESExACBBodHx/9oACAEBAAE/ELpaTuHZE8/OOoBQjsuMHAsL1kPvoX//2Q=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"kops logo","title":"kops logo","src":"/static/25578d904e75c8bffd298a079b4a3e89/88218/kops-logo.jpg","srcSet":["/static/25578d904e75c8bffd298a079b4a3e89/7237a/kops-logo.jpg 148w","/static/25578d904e75c8bffd298a079b4a3e89/0cfdf/kops-logo.jpg 295w","/static/25578d904e75c8bffd298a079b4a3e89/88218/kops-logo.jpg 590w","/static/25578d904e75c8bffd298a079b4a3e89/77d57/kops-logo.jpg 885w","/static/25578d904e75c8bffd298a079b4a3e89/5a917/kops-logo.jpg 1180w","/static/25578d904e75c8bffd298a079b4a3e89/c23ee/kops-logo.jpg 2191w"],"sizes":["(max-width:","590px)","100vw,","590px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"CẬP NHÂT: "},{"type":"element","tagName":"br","properties":{},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Có rất nhiều cách để run K8S trên AWS như "},{"type":"element","tagName":"a","properties":{"href":"https://aws.amazon.com/eks/"},"children":[{"type":"text","value":"EKS"}]},{"type":"text","value":" hay sử dụng Kops. Kops là 1 cách đơn giản và dễ dàng customize  việc cài đặt K8S. Trong bài viết này chúng ta sẽ bàn về cách sử dụng Kops để cài đặt K8S trên AWS."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"1. Yêu cầu trước khi cài đặt Cluster trên AWS"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"Cài đặt kubectl"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Để cài đặt cluster, bạn phải cài đặt thành công kubectl trước. kubectl là Kubernetes command-line tool giúp bạn chạy lệnh trên Kubernetes cluster. Bạn có thể sử dụng kubectl để deploy applications, kiểm tra và quản lý tài nguyên cluster, và xem logs."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"sh"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-sh"]},"children":[{"type":"text","value":"curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl\nchmod +x ./kubectl\nmv ./kubectl /usr/local/bin/kubectl"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"Cài dặt kops"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"sh"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-sh"]},"children":[{"type":"text","value":"KOPS_VERSION=1.12.0\ncurl -LO https://github.com/kubernetes/kops/releases/download/${KOPS_VERSION}/kops-darwin-amd64\nchmod +x ./kops-darwin-amd64\nmv ./kops-darwin-amd64 ./bin/kops"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"Cài đặt aws cli"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Đầu tiên bạn cần 1 tài khoản AWS và "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"Tạo route53 cho cluster"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kops sử dụng DNS cho việc tìm kiếm, cả ở bên trong cluster vì thế bạn có thể sử dụng kubernestes API server từ clients."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kops có nhưng quan điểm mạnh mẽ về cluster name: nó phải là 1 DNS name còn hiệu lực. Bằng cách này, bạn sẽ ko bao giờ phải băn khoăn về cluster của mình, bạn có thể sẽ nó cho đồng nghiệp rõ ràng cũng như có thể truy cập vào cluster mà không cần nhớ API."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bạn nên sử dụng subdomain để phần chia cluster của bạn. Như trong ví dụ, chúng ta sẽ sử dụng "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"useast1.dev.example.com"}]},{"type":"text","value":". API của server sẽ là "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"api.useast1.dev.example.com"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"Tạo S3 Bucket để lưu trũ trạng thái của Cluster"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kops cho phép bạn quản lý cluster của bạn ngay cả sau khi đã cài đặt. Để làm được điều này, kops cần phải lưu trạng thái của cluster mà bạn tạo, bên cạnh config của nó cũng như nhũng keys mà nó sử dụng. Những thông tin này sẽ được lưu trữ ở S3 bucket."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nhiều cluster có thể được sử dụng chung 1 S3 bucket, và bạn cũng có thể share bucket này với đồng nghiệp của bạn để quản lý cùng 1 cluster - cách này thì dễ hơn việc truyền nhau những files kubecfg. Nhưng ai có quyền truy cập vào S3 bucket cũng có thể quản lý và điều khiển được tất cả các cluster. Vậy nên bạn sẽ không nên share nó cho ai ngoài team vận hành."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nên về nguyên tắc, bạn nên tạo 1 bucket cho mỗi team vẫn hành riêng biệt."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ở trong ví dụ của chúng ta, chúng ta chọn "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"dev.example.com"}]},{"type":"text","value":" như là hosted zone nên hãy chọn "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"clusters.dev.example.com"}]},{"type":"text","value":" bucket cho tên của S3 bucket."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"2. Cài đặt K8S trên AWS"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"sh"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-sh"]},"children":[{"type":"text","value":"$ kops create cluster --name=k8s.fiftyline.com --state=s3://k8s.fiftyline.com --zones=us-east-1aundefinedus-east-1bundefinedus-east-1cundefinedus-east-1dundefinedus-east-1eundefinedus-east-1f --node-count=2 --node-size=t2.micro --master-size=t2.medium --dns-zone=k8s.fiftyline.com --ssh-public-key=../.ssh/id_rsa.pub\n\n$ kops update cluster --name k8s.fiftyline.com --state=s3://k8s.fiftyline.com --yes"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"3. Thay đổi cấu hình cho Node và Master"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"How to edit node type:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"sh"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-sh"]},"children":[{"type":"text","value":"$ kops edit ig nodes --state=s3://k8s.fiftyline.com\n\nUsing cluster from kubectl context: k8s.fiftyline.com\n\n$ kops get ig nodes --state=s3://k8s.fiftyline.com\n\nUsing cluster from kubectl context: k8s.fiftyline.com\n\nNAME\tROLE\tMACHINETYPE\tMIN\tMAX\tZONES\nnodes\tNode\tt2.micro\t2\t2\tus-east-1c\n\n$ kops update cluster k8s.fiftyline.com --yes --state=s3://k8s.fiftyline.com\n\n$ kops rolling-update cluster k8s.fiftyline.com --yes --state=s3://k8s.fiftyline.com"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"How to edit master type:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"sh"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-sh"]},"children":[{"type":"text","value":"$ kops get ig --state=s3://k8s.fiftyline.com\n\nUsing cluster from kubectl context: k8s.fiftyline.com\n\nNAME\t\t\tROLE\tMACHINETYPE\tMIN\tMAX\tZONES\nmaster-us-east-1c\tMaster\tm3.medium\t1\t1\tus-east-1c\nnodes\t\t\tNode\tt2.micro\t2\t2\tus-east-1c\n\n$ kops edit ig master-us-east-1c --state=s3://k8s.fiftyline.com\n\n$ kops update cluster k8s.fiftyline.com --yes --state=s3://k8s.fiftyline.com\n\n$ kops rolling-update cluster k8s.fiftyline.com --yes --state=s3://k8s.fiftyline.com"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Chạy thử ứng dụng trên cluster"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"sh"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-sh"]},"children":[{"type":"text","value":"$ kubectl get node\n\nNAME                            STATUS   ROLES    AGE    VERSION\nip-172-20-42-246.ec2.internal   Ready    master   85m    v1.12.7\nip-172-20-47-83.ec2.internal    Ready    node     118m   v1.12.7\nip-172-20-61-189.ec2.internal   Ready    node     111m   v1.12.7\n\n$ kubectl run hello-minikube --image=gcr.io/google_containers/echoserver:1.4 --port=8080\n\nkubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.\ndeployment.apps/hello-minikube created\n\n$ kubectl expose deployment hello-minikube --type=NodePort\n\nservice/hello-minikube exposed\n\n$ kubectl get services\n\nNAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE\nhello-minikube   NodePort    100.64.87.249   <none>        8080:32471/TCP   39s\nkubernetes       ClusterIP   100.64.0.1      <none>        443/TCP          157m\n\n$ kubectl delete services hello-minikube\n\n$ kubectl delete deployment hello-minikube"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"x. Xóa cluster"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"sh"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-sh"]},"children":[{"type":"text","value":"$ kops delete cluster k8s.fiftyline.com --state=s3://k8s.fiftyline.com --yes"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Kết luận"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Link tham khảo"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/setup/custom-cloud/kops/"},"children":[{"type":"text","value":"Installing Kubernetes on AWS with kops"}]}]},{"type":"text","value":"\n"}]}],"data":{"quirksMode":false}},"frontmatter":{"title":"How to setup K8S Cluster on AWS by using Kops","date":"May 16, 2019"}}},"pageContext":{"slug":"/2019-05-16-how-to-setup-kops-on-aws/","previous":{"fields":{"slug":"/2019-05-10-how-to-run-minikube-on-aws-ec2/"},"frontmatter":{"title":"How to run minikube on AWS EC2"}},"next":{"fields":{"slug":"/2019-05-23-financial-management-skill/"},"frontmatter":{"title":"Kỹ năng quản lý tài chính"}}}}}